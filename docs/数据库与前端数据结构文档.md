# DevNote 数据库与前端数据结构文档

## 概述
DevNote应用采用SQLite数据库存储数据，前端使用Vue 3的响应式数据结构。本文档详细说明了数据库表结构、前端数据类型和每个字段的作用。

---

## 1. 待办事项 (Todo)

### 数据库表结构 (`todos`)
```sql
CREATE TABLE IF NOT EXISTS todos (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT DEFAULT '',
  priority INTEGER DEFAULT 2,
  finished BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  completed_at DATETIME,
  block_id TEXT,
  idea_id TEXT,
  idea_content TEXT
)
```

### TypeScript接口定义
```typescript
interface Todo {
  id?: number
  title: string
  content: string
  priority: number // 1-3
  finished: boolean
  created_at: string
  completed_at?: string
  block_id?: string
  idea_id?: string
  idea_content?: string
}
```

### 字段说明
| 字段名 | 数据类型 | 作用 | 备注 |
|--------|----------|------|------|
| `id` | INTEGER | 唯一标识符 | 自增主键 |
| `title` | TEXT | 待办事项标题 | 必填，显示在列表中的主要内容 |
| `content` | TEXT | 详细描述内容 | 支持Markdown格式，可展开查看 |
| `priority` | INTEGER | 优先级 | 1=高，2=中，3=低，影响排序和显示颜色 |
| `finished` | BOOLEAN | 完成状态 | true=已完成，false=待完成 |
| `created_at` | DATETIME | 创建时间 | 自动生成，用于排序和显示 |
| `completed_at` | DATETIME | 完成时间 | 完成时自动设置，用于统计和显示 |
| `block_id` | TEXT | 关联的工作区块ID | 从工作区块创建时设置，用于关联 |
| `idea_id` | TEXT | 关联的想法ID | 从想法创建时设置，建立关联关系 |
| `idea_content` | TEXT | 想法内容快照 | 保存创建时的想法内容，避免引用丢失 |

### 前端状态管理
```javascript
const todos = reactive([])  // 所有待办事项数组
const sortedTodos = computed(() => {})  // 排序后的待办事项
const expandedTodos = reactive(new Set())  // 展开状态管理
```

---

## 2. Bug记录 (Bug)

### 数据库表结构 (`bugs`)
```sql
CREATE TABLE IF NOT EXISTS bugs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT DEFAULT '',
  severity INTEGER DEFAULT 2,
  fixed BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  completed_at DATETIME,
  additional_info TEXT
)
```

### TypeScript接口定义
```typescript
interface Bug {
  id?: number
  title: string
  description: string
  severity: number // 1-3
  fixed: boolean
  created_at: string
  completed_at?: string
  additional_info?: string
}
```

### 字段说明
| 字段名 | 数据类型 | 作用 | 备注 |
|--------|----------|------|------|
| `id` | INTEGER | 唯一标识符 | 自增主键 |
| `title` | TEXT | Bug标题 | 必填，简要描述Bug |
| `description` | TEXT | Bug详细描述 | 详细说明Bug现象、重现步骤等 |
| `severity` | INTEGER | 严重程度 | 1=严重，2=中等，3=轻微 |
| `fixed` | BOOLEAN | 修复状态 | true=已修复，false=未修复 |
| `created_at` | DATETIME | 创建时间 | 自动生成 |
| `completed_at` | DATETIME | 修复时间 | 标记为已修复时设置 |
| `additional_info` | TEXT | 附加信息 | 修复方案、备注等额外信息 |

### 前端状态管理
```javascript
const bugs = reactive([])  // 所有Bug记录
const sortedBugs = computed(() => {})  // 排序后的Bug列表
const selectedBug = ref(null)  // 当前选中的Bug（用于详情卡片）
```

---

## 3. 想法池 (Idea)

### 数据库表结构 (`ideas`)
```sql
CREATE TABLE IF NOT EXISTS ideas (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT DEFAULT '',
  status TEXT DEFAULT 'active',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

### TypeScript接口定义
```typescript
interface Idea {
  id?: number
  title: string
  content: string
  status: 'active' | 'in-progress' | 'completed' | 'discarded'
  created_at: string
}
```

### 字段说明
| 字段名 | 数据类型 | 作用 | 备注 |
|--------|----------|------|------|
| `id` | INTEGER | 唯一标识符 | 自增主键 |
| `title` | TEXT | 想法标题 | 必填，想法的核心概念 |
| `content` | TEXT | 想法详细内容 | 详细描述想法的具体内容 |
| `status` | TEXT | 想法状态 | active=活跃，in-progress=进行中，completed=已完成，discarded=已废弃 |
| `created_at` | DATETIME | 创建时间 | 自动生成 |

### 前端状态管理
```javascript
const ideas = reactive([])  // 所有想法
const expandedIdeas = reactive(new Set())  // 展开状态管理
const showIdeaTooltip = ref(null)  // 想法悬浮提示状态
```

---

## 4. 笔记 (Note)

### 数据库表结构 (`notes`)
```sql
CREATE TABLE IF NOT EXISTS notes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT DEFAULT '',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_modified DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

### TypeScript接口定义
```typescript
interface Note {
  id?: number
  title: string
  content: string
  created_at: string
  last_modified: string
}
```

### 字段说明
| 字段名 | 数据类型 | 作用 | 备注 |
|--------|----------|------|------|
| `id` | INTEGER | 唯一标识符 | 自增主键 |
| `title` | TEXT | 笔记标题 | 必填，笔记的主题 |
| `content` | TEXT | 笔记内容 | 支持Markdown格式的长文本内容 |
| `created_at` | DATETIME | 创建时间 | 自动生成 |
| `last_modified` | DATETIME | 最后修改时间 | 内容更新时自动更新 |

### 前端状态管理
```javascript
const notes = reactive([])  // 所有笔记
const selectedNote = ref(null)  // 当前选中的笔记
const openNoteTabs = reactive([])  // 打开的笔记标签页
const activeNoteTab = ref(null)  // 当前激活的标签页
const temporaryTab = ref(null)  // 临时标签页（单击产生）
```

---

## 5. 项目进度 (Progress)

### 数据库表结构 (`progresses`)
```sql
CREATE TABLE IF NOT EXISTS progresses (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date DATE NOT NULL UNIQUE,
  content TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

### TypeScript接口定义
```typescript
interface Progress {
  id?: number
  date: string
  content: string // JSON数组存储
  created_at: string
}
```

### 字段说明
| 字段名 | 数据类型 | 作用 | 备注 |
|--------|----------|------|------|
| `id` | INTEGER | 唯一标识符 | 自增主键 |
| `date` | DATE | 进度日期 | 唯一约束，每天只能有一条进度记录 |
| `content` | TEXT | 进度内容 | JSON格式存储的字符串数组，每项是一条进度 |
| `created_at` | DATETIME | 创建时间 | 自动生成 |

### 数据存储格式
- **数据库存储**: `'["任务1", "任务2", "任务3"]'` (JSON字符串)
- **前端处理**: `["任务1", "任务2", "任务3"]` (JavaScript数组)

### 前端状态管理
```javascript
const progresses = reactive([])  // 所有项目进度
const todayProgress = ref(null)  // 今日进度指针
const sortedProgresses = computed(() => {})  // 按日期排序的进度
```

---

## 6. 工作区块 (Block)

### 数据库表结构 (`blocks`)
```sql
CREATE TABLE IF NOT EXISTS blocks (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,
  content TEXT DEFAULT '',
  priority INTEGER,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
)
```

### TypeScript接口定义
```typescript
interface Block {
  id: string
  type: 'todo' | 'bug' | 'idea' | 'note' | 'progress'
  content: string
  priority?: number
  created_at: string
}
```

### 字段说明
| 字段名 | 数据类型 | 作用 | 备注 |
|--------|----------|------|------|
| `id` | TEXT | 唯一标识符 | UUID格式，确保全局唯一 |
| `type` | TEXT | 区块类型 | 决定区块的功能和同步目标 |
| `content` | TEXT | 区块内容 | 支持Markdown格式的文本内容 |
| `priority` | INTEGER | 优先级 | 可选，主要用于todo类型的区块 |
| `created_at` | DATETIME | 创建时间 | 自动生成，用于排序 |

### 区块类型说明
| 类型 | 说明 | 同步目标 | 显示颜色 |
|------|------|----------|----------|
| `todo` | 待办事项区块 | 同步到待办清单 | 蓝色 |
| `bug` | Bug记录区块 | 同步到Bug列表 | 红色 |
| `idea` | 想法区块 | 同步到想法池 | 紫色 |
| `note` | 笔记区块 | 同步到笔记 | 绿色 |
| `progress` | 进度区块 | 同步到项目进度 | 橙色 |

### 前端状态管理
```javascript
const blocks = reactive([])  // 当天的工作区块
const editingBlockId = ref(null)  // 当前编辑的区块ID
const blockRefs = new Map()  // 区块DOM引用映射
```

### 数据生命周期
- **创建**: 用户在工作区输入内容或使用命令创建
- **编辑**: 双击进入编辑模式，失焦时自动保存
- **同步**: 按Ctrl+S时同步到对应的数据表
- **清理**: 每天启动时自动删除前一天的区块数据

---

## 7. 前端响应式状态

### 全局状态
```javascript
// 应用初始化状态
const isInitialized = inject('isInitialized')
const initializationError = inject('initializationError')

// 界面状态
const activeTab = ref('todo')  // 当前激活的侧边栏标签页
const isInNoteMode = ref(false)  // 是否在笔记模式
const currentDate = ref(new Date())  // 当前选择的日期

// 布局状态
const leftWidth = ref(280)  // 左侧栏宽度
const isResizing = ref(false)  // 是否正在调整大小
```

### 编辑状态
```javascript
const input = ref('')  // 主输入框内容
const commandInput = ref('')  // 命令输入框内容
const editingBlockId = ref(null)  // 当前编辑的区块ID
```

### UI交互状态
```javascript
// Bug详情卡片
const showBugDetailCard = ref(false)
const selectedBug = ref(null)
const selectedBugIndex = ref(-1)

// 拖拽状态
const isDragging = ref(false)
const dragStartX = ref(0)
const dragStartY = ref(0)

// 展开状态
const expandedTodos = reactive(new Set())
const expandedIdeas = reactive(new Set())
const allTodosExpanded = ref(false)
```

---

## 8. 数据流向和同步机制

### 数据加载流程
1. **应用启动** → `initProject()` → `initDatabase()` → `loadAllData()`
2. **并行加载** → 所有API的`getAll()`方法同时执行
3. **数据处理** → JSON解析、日期转换、响应式包装
4. **状态同步** → 更新前端响应式数组

### 数据保存流程
1. **用户输入** → 区块内容变化
2. **触发同步** → Ctrl+S或自动同步
3. **数据验证** → 检查必填字段
4. **API调用** → 对应的create/update方法
5. **状态更新** → 更新前端数组和指针

### 数据清理机制
- **blocks表**: 每天启动时清理前一天的数据
- **progresses表**: 保留所有历史记录，不自动清理
- **其他表**: 仅通过用户操作删除

---

## 9. 数据关联关系

### Todo ← → Block 关联
- `todos.block_id` 关联 `blocks.id`
- 用于从工作区块创建待办事项时建立联系

### Todo ← → Idea 关联  
- `todos.idea_id` 关联 `ideas.id`
- `todos.idea_content` 保存想法内容快照
- 用于从想法池创建待办事项时保持关联

### Block → Progress 关联
- 多个 `type='progress'` 的区块合并为一天的进度记录
- 通过日期进行关联，不是直接的外键关系

---

## 10. 性能优化说明

### 数据库层面
- 使用`INSERT OR REPLACE`避免重复数据
- 为常用查询字段建立索引
- 定期清理临时数据(blocks)

### 前端层面
- 使用`reactive()`实现细粒度响应式更新
- `computed()`缓存排序和过滤结果
- `nextTick()`确保DOM更新后操作
- 虚拟滚动优化长列表(如需要)

### 内存管理
- Map结构管理DOM引用避免内存泄漏
- 组件卸载时清理事件监听器
- 合理使用ref vs reactive

---

*此文档生成时间: 2025年9月21日*  
*涵盖版本: DevNote v0.1.0*  
*数据库版本: SQLite*